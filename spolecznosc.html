<div class="spolecznosc-content">
    <h2>Logi Społeczności</h2>
    <div class="log-table-container">
        <table id="logTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Dzień</th>
                    <th>Godzina</th>
                    <th>IP</th>
                    <th>Lokalizacja</th>
                    <th>Urządzenie</th>
                </tr>
            </thead>
            <tbody id="logTableBody">
                <!-- Logi będą dynamicznie wstawiane -->
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { getDatabase, ref, get, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js';

    const db = getDatabase();
    const logsRef = ref(db, 'logs');
    const usersRef = ref(db, 'users');

    async function updateLogs() {
        console.groupCollapsed("Aktualizacja logów");
        try {
            console.log('Pobieranie logów z Firebase');
            const logsQuery = query(logsRef, orderByChild('timestamp'), limitToLast(100));
            const logsSnapshot = await get(logsQuery);
            const logsData = logsSnapshot.val();
            let logs = logsData ? Object.entries(logsData).map(([key, value]) => ({ key, ...value })) : [];
            logs.sort((a, b) => b.timestamp - a.timestamp);
            console.log('Pobrano logi:', logs.length);

            console.log('Pobieranie danych użytkowników');
            const usersSnapshot = await get(usersRef);
            const usersData = usersSnapshot.val() || {};
            console.log('Pobrano użytkowników:', Object.keys(usersData).length);

            displayLogs(logs, usersData);
        } catch (error) {
            console.error('Błąd pobierania logów:', error);
            const logTableBody = document.getElementById('logTableBody');
            logTableBody.innerHTML = '<tr><td colspan="6">Błąd ładowania logów.</td></tr>';
        }
        console.groupEnd();
    }

    function displayLogs(logs, usersData) {
        const logTableBody = document.getElementById('logTableBody');
        logTableBody.innerHTML = '';

        if (logs.length === 0) {
            logTableBody.innerHTML = '<tr><td colspan="6">Brak logów.</td></tr>';
            return;
        }

        logs.slice(0, 10).forEach(log => {
            const row = document.createElement('tr');
            const ip = log.ip || 'Brak';
            let ipDisplay = ip;

            for (const uid in usersData) {
                if (usersData[uid].lastIp === ip) {
                    ipDisplay = `${ip}<br>(${usersData[uid].customUsername})`;
                    break;
                }
            }

            row.innerHTML = `
                <td>${log.date || 'Brak'}</td>
                <td>${log.day || 'Brak'}</td>
                <td>${log.time || 'Brak'}</td>
                <td>${ipDisplay}</td>
                <td>${log.location.city || 'Nieznane miasto'}<br>(${log.location.country || 'Nieznany kraj'})</td>
                <td>${log.device || 'Brak'}<br>(${log.isp || 'Nieznany dostawca'})</td>
            `;
            logTableBody.appendChild(row);
        });
    }

    updateLogs();
</script>
